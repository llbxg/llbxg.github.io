+++
title = "Flaskã§å‹•çš„ã«routeã‚’è¿½åŠ ã™ã‚‹"
date = "2023-01-07"
description = "forãƒ«ãƒ¼ãƒ—ã‚’ä½¿ã£ã¦routeã‚’è¿½åŠ ã™ã‚‹éš›ã®ã‚ã‚‚ã§ã™ã€‚"
[taxonomies]
tags = ["Flask", "Python", "werkzeug"]
+++

forãƒ«ãƒ¼ãƒ—ã‚’ä½¿ã£ã¦routeã‚’è¿½åŠ ã™ã‚‹éš›ã®ã‚ã‚‚ã§ã™ã€‚

(ã¤ã„ã§ã« The Hitchhikerâ€™s Guide to Python ã® Common Gotchas [^6]ã®ãƒ¡ãƒ¢ã‚‚è¿½è¨˜ã—ã¦ã„ã¾ã™ã€‚) 

<br>

æœ€å°é™ã®æœ€å°é™ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³[^1]ã‚’æº–å‚™ã—ã¾ã™ã€‚

```python
from flask import Flask

app = Flask(__name__)

@app.route("/")
def hello_world():
    return "<p>Hello, World!</p>"
```

**æ–°ã—ã/popcornã¨/creamsoadã®ï¼’ã¤ã®ãƒ«ãƒ¼ãƒˆã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚’è€ƒãˆã¾ã™ã€‚**

[TOC]

## ä¸€èˆ¬çš„ãªæ–¹æ³•

ãã‚Œãã‚Œå€‹åˆ¥ã§å®šç¾©ã™ã‚‹æ–¹æ³•ã§ã™ã€‚ `route()`[^2] ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä½¿ã†ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«è¿½åŠ ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

```python
@app.route('/popcorn')
def popcorn():
    return 'ğŸ¿ popcorn'

@app.route('/creamsoad')
def creamsoad():
    return 'ğŸ¥¤ cream soad'
```

ã“ã®æ–¹æ³•ã§ã‚‚ç‰¹ã«å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€å˜ç´”ã ã£ãŸã‚Šã€é‡è¤‡çš„ãªå ´åˆã¯ä¸€æ°—ã«ä½œæˆã—ãŸããªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

## loopã‚’ä½¿ã£ã¦è¿½åŠ ã™ã‚‹

forã®loopå†…ã§viewé–¢æ•°ã‚’å®šç¾©ã—ã€`add_url_rule()`[^3] ã‚’ä½¿ã£ã¦è¿½åŠ ã—ã¦ã„ãã¾ã™ã€‚

```python
from functools import partial


s = {'popcorn': 'ğŸ¿ popcorn', 'creamsoad': 'ğŸ¥¤ cream soad'}

for key, value in s.items():

    def temp_func(v):
        return v

    view_func = partial(temp_func, v=value)

    app.add_url_rule(f'/{key}', endpoint=key, view_func=view_func)
```

å®Ÿéš›ã«app.run()ã§èµ·å‹•ã•ã›ã€httpã‚³ãƒãƒ³ãƒ‰ [^4] ã‚’ä½¿ç”¨ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚


```bash
$ http http://127.0.0.1:5000/popcorn
HTTP/1.1 200 OK
Connection: close
Content-Length: 12
Content-Type: text/html; charset=utf-8
Date: Xxx, xx Xxx 2022 xx:xx:xx GMT
Server: Werkzeug/2.2.2 Python/3.9.9

ğŸ¿ popcorn
```

`/popcorn`ã¸ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

ä»¥ä¸‹ã§ã¯ãŠã¾ã‘ã¨ã—ã¦ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã®é…å»¶è©•å¯¾ç­–ã¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã¤ã„ã¦è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚

## Late Binding Closures

ä¸Šè¨˜ä¾‹ã§ã¯ã€`add_url_rule`ã§viewé–¢æ•°ã‚’ç™»éŒ²ã™ã‚‹éš›ã«`functools.partial` [^5] ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã¯ **Late Binding Closures** (ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã®é…å»¶è©•ä¾¡)ã‚’æ»ã„æ½œã‚‹(?)ãŸã‚ã«å¿…è¦ã§ã™ã€‚

ã‚‚ã—`partial`ã‚’ä½¿ç”¨ã—ãªã„å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```python
s = {'popcorn': 'ğŸ¿ popcorn', 'creamsoad': 'ğŸ¥¤ cream soad'}

for key, value in s.items():

    def temp_func():
        return value

    app.add_url_rule(f'/{key}', endpoint=key, view_func=temp_func)
```

`s.items()`ã§ä¸ãˆã‚‰ã‚ŒãŸvalueã‚’`temp_func`ã®å¼•æ•°ã§ã¯ãªããã®ã¾ã¾ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

`/popcorn`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚

```bash
$ http http://127.0.0.1:5000/popcorn
HTTP/1.1 200 OK
Connection: close
Content-Length: 15
Content-Type: text/html; charset=utf-8
Date: Xxx, xx Xxx 2022 xx:xx:xx GMT
Server: Werkzeug/2.2.2 Python/3.9.9

ğŸ¥¤ cream soad
```

æœŸå¾…ã•ã‚Œã‚‹ ğŸ¿ popcorn ã§ã¯ãªã ğŸ¥¤ cream soad ãŒè¿”ã£ã¦ãã¾ã—ãŸã€‚

ã“ã‚Œã¯ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã§å¤‰æ•°ã‚’ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹ã“ã¨ã§ç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚

(ä»Šå›ã§ã‚ã‚Œã°ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£`temp_func`å†…ã§`value`ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚`/popcorn`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€`view_func(=temp_func)`ãŒ`value`ã‚’è¿”ã™æ™‚ã«ãƒã‚¤ãƒ³ãƒ‰ã•ã‚Œã¦ã„ã‚‹"cream soda"ãŒè¿”ã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚)

### ç°¡å˜ãªä¾‹

ã‚ˆã‚Šç°¡å˜ãªä¾‹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```python
fs = [lambda : n**2 for n in [1, 2, 3]]
print([f() for f in fs])
```

1, 2, 3ã®2ä¹—ãŒè¿”ã•ã‚Œã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ãŸã‚`[1, 4, 9]`ã‚’è€ƒãˆã¾ã™ãŒã€å®Ÿéš›ã«ã¯`[9, 9, 9]`ãŒè¿”ã£ã¦ãã¾ã™ã€‚


Pythonã®ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã«ãŠã‘ã‚‹é…å»¶ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã¯ "The Hitchhikerâ€™s Guide to Python" ãªã©ã§è©³ã—ãç¢ºèªã§ãã¾ã™[^7]ã€‚

`functools.partial`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§å¼•æ•°ãŒè©•ä¾¡ã•ã‚ŒæœŸå¾…é€šã‚Šã«å‹•ä½œã—ã¾ã™ã€‚

```python
import functools
import math

fs = [functools.partial(math.pow, n) for n in [1, 2, 3]]
print([f(2) for f in fs])  # [1.0, 4.0, 9.0]
```

é–¢æ•°ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¼•æ•°ãŒé–¢æ•°ãŒå®šç¾©ã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è©•ä¾¡ã•ã‚Œã‚‹ã“ã¨ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™[^8]ã€‚

ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æ©Ÿèƒ½ã‚’è¿½åŠ ã—ãŸã‚Šã™ã‚‹éš›ã«ã‚‚åˆ©ç”¨ã§ãã¾ã™ã—ã€ä»Šå›ã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã§å…ˆã«è©•ä¾¡ã—ã¦ã‚‚ã‚‰ã†ã“ã¨ã§æœŸå¾…é€šã‚Šå‹•ä½œã—ã¾ã™ã€‚

```python
fs = [lambda i=n: i**2 for n in [1, 2, 3]]
print([f() for f in fs])  # [1, 4, 9]
```

ãŸã ã€å€‹äººçš„ã«ã¯`functools.partial`ã®æ–¹ãŒæ„å›³ã‚’æ±²ã¿ã‚„ã™ã„æ°—ãŒã™ã‚‹ã®ã§ä½¿ã£ã¦ã„ã¾ã™ã€‚

## endpoint

ä¸Šè¨˜ä¾‹ã§ã¯`add_url_rule`ã‚’ã™ã‚‹éš›ã«`endpoint=key`ã®ã‚ˆã†ã«ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

<br>

`add_url_rule`ã«ãŠã„ã¦ã€`view_function`ãŒç™»éŒ²ã•ã‚Œã‚‹å ´æ‰€ã‚’ç°¡ç•¥çš„ã«è¡¨ã™ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
(è©³ã—ãã¯`flask/app.py`ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚)

```python
    ...
    def add_url_rule(self,
            rule, endpoint=None, view_func=None, 
            provide_automatic_options=None, **options):
        if endpoint is None:
            endpoint = view_func.__name__

        ...

        self.view_functions[endpoint] = view_func
    ...
```

`endpoint`ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯`.__name__`ã‚’ä½¿ç”¨ã—ã¦é–¢æ•°ã®åå‰ã‚’è¨­å®šã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

ã—ã‹ã—ã€`partial`ã‚’ä½¿ç”¨ã—ãŸå ´åˆã¯`.__name__`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ããšã‚¨ãƒ©ãƒ¼ã‚’åãã¾ã™ã€‚

ãã®ãŸã‚ã€`endpoint=key`ã®ã‚ˆã†ã«æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```python
AttributeError: 'functools.partial' object has no attribute '__name__'
```

åŒã˜`endpoint`ã«å¯¾ã—ã¦è¤‡æ•°ã®ç™»éŒ²ãŒç¢ºèªã•ã‚Œã‚‹ã¨ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚(`flask/scaffold.py`ã®`_endpoint_from_view_func`ã«ã¦)

ä¾‹ãˆã°`partial`ã‚’ä½¿ç”¨ã›ãšview_functionã«`temp_func`ã‚’ä½¿ç”¨ã—ã€`endpoint`ã‚’æŒ‡å®šã—ãªã‹ã£ãŸå ´åˆãªã©ã§ã™ã€‚

```python
AssertionError: View function mapping is overwriting an existing endpoint function: temp_func
```

æœ€çµ‚çš„ã«Responseã¨ã—ã¦`view_functions`å†…ã®é–¢æ•°ãŒendpointã‚’**key**ã¨ã—ã¦è¿”ã•ã‚Œã¾ã™ã€‚

### ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°



å®Ÿéš›ã«`app`ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç­‰ã‚’ç¢ºèªã—ãŸã„å ´åˆã¯

* ç›´æ¥`view_functions`ã‚’ç¢ºèªã™ã‚‹
* `url_map`ã§Map[^9]ã‚’ç¢ºèªã™ã‚‹

ãªã©ãŒã‚ã‚Šã¾ã™ã€‚

<br>

`app.view_functions`

```python
{
    'static': <function Flask.__init__.<locals>.<lambda> at 0x1045d2820>, 
    'popcorn': functools.partial(<function temp_func at 0x1045e5310>, v='ğŸ¿ popcorn'), 
    'creamsoad': functools.partial(<function temp_func at 0x1045e53a0>, v='ğŸ¥¤ cream soad')}
```

`app.url_map`

```python
Map([
    <Rule '/static/<filename>' (OPTIONS, HEAD, GET) -> static>,
    <Rule '/popcorn' (OPTIONS, HEAD, GET) -> popcorn>,
    <Rule '/creamsoad' (OPTIONS, HEAD, GET) -> creamsoad>])
```

## å‚è€ƒæ–‡çŒ®
[^6]: [Common Gotchas - The Hitchhikerâ€™s Guide to Python](https://docs.python-guide.org/writing/gotchas/)

[^1]: [A Minimal Application - flask.palletsprojects.com](https://flask.palletsprojects.com/en/2.2.x/quickstart/#a-minimal-application)

[^2]: [route - flask.palletsprojects.com](https://flask.palletsprojects.com/en/2.2.x/api/#flask.Flask.route)

[^3]: [add_url_rule - flask.palletsprojects.com](https://flask.palletsprojects.com/en/2.2.x/api/#flask.Flask.add_url_rule)

[^4]: [httpie.io](https://httpie.io) / [httpie - GitHub](https://github.com/httpie/httpie)

[^5]: [functools.partial - docs.python.org](https://docs.python.org/ja/3/library/functools.html#functools.partial)

[^7]: [Late Binding Closures - The Hitchhikerâ€™s Guide to Python](https://docs.python-guide.org/writing/gotchas/#late-binding-closures)

[^8]: [Mutable Default Arguments - The Hitchhikerâ€™s Guide to Python](https://docs.python-guide.org/writing/gotchas/#mutable-default-arguments)

[^9]: [werkzeug-map](https://werkzeug.palletsprojects.com/en/2.2.x/routing/#maps-rules-and-adapters)