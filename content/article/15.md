+++
title = "OpenSeeFaceã¨Godot4ã‚’ç¹‹ã"
date = "2023-06-03"
description = "OpenSeeFaceã§é¡”ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚’æ¤œå‡ºã—ã¦ã€çµæœã‚’ã‚½ã‚±ãƒƒãƒˆé€šä¿¡(UDP)ã§å—ã‘å–ã£ãŸã¨ãã®ãƒ¡ãƒ¢ã§ã™ã€‚"
[taxonomies]
tags = ["Godot4", "OpenSeeFace", "Python"]
+++

OpenSeeFace[^1]ã§é¡”ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚’æ¤œå‡ºã—ã¦ã€çµæœã‚’ã‚½ã‚±ãƒƒãƒˆé€šä¿¡(UDP)ã§å—ã‘å–ã£ãŸã¨ãã®ãƒ¡ãƒ¢ã§ã™ã€‚

c#ã§å—ã‘å–ã‚‹ä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚ã¤ã„ã§ã«ã€pythonã‚’Godotã‹ã‚‰å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã‚‚è¼‰ã›ã¦ãŠãã¾ã™ã€‚

[TOC]

## ç’°å¢ƒ

Godot: `v4.0.2.stable.official`

Python: `3.9.9`

OpenSeeFace: `9e07f6e1993022e7679f2e5ee3daec0ff617fac1`

## OpenSeeFaceã¨ã¯

OpenSeeFaceã¯ã€MobileNetV3ã«åŸºã¥ã„ãŸé¡”ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯æ¤œå‡ºãƒ¢ãƒ‡ãƒ«ã‚’å®Ÿè£…ã—ãŸãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
é¡”ã®ç‰¹å¾´ç‚¹(ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯)ã‚’æ¤œå‡ºã—ã€ãã‚Œã‚’åŸºã«é¡”ã®å‹•ãã‚’è¿½è·¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

Webã‚«ãƒ¡ãƒ©å…¥åŠ›ã¾ãŸã¯ãƒ“ãƒ‡ã‚ªãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®é¡”ã®ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚’è¡Œã„ã€ãã®ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’**UDPçµŒç”±ã§é€ä¿¡**ã—ã¾ã™ã€‚

ã“ã®é€ä¿¡ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¯3Dãƒ¢ãƒ‡ãƒ«ã€ã¾ãŸã¯Live2Dãƒ¢ãƒ‡ãƒ«ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§åˆ©ç”¨ã§ãã¾ã™ã€‚

ã“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã¯ã€è¤‡æ•°ã®ãƒ¢ãƒ‡ãƒ«ã‚’æä¾›ã—ã¦ãŠã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç’°å¢ƒã«åˆã‚ã›ã¦å¤‰æ›´ã§ãã¾ã™ã€‚

## ãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡å´

OpenSeeFaceã§ã¯`facetracker.py`[^2]ã‚’å®Ÿè¡Œã—ã¦èµ·å‹•ã—ã¾ã™ã€‚

```bash
$ python facetracker.py -P 1 --log-data output.log
```

`facetracker.py`ã«ã¦sendtoã«ã‚ˆã‚Šãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒé€ä¿¡ã•ã‚Œã¦ã„ã¾ã™ã€‚

```python
sock.sendto(packet,  (target_ip,  target_port))
```

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ipãŒlocalhost(127.0.0.1)ã€portã¯11573ã§ã™ã€‚å®Ÿè¡Œæ™‚ã®å¼•æ•°ã¨ã—ã¦ä¸ãˆã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

`packet`ã¯`bytearray()`ã«ã‚ˆã£ã¦ä½œæˆã•ã‚Œã€`packet.extend(bytearray(struct.pack("d",  now)))`ã®ã‚ˆã†ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚

ä½•ã®ãƒ‡ãƒ¼ã‚¿ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ã¯logãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã™ã‚‹ã®ãŒè‰¯ã„ã§ã—ã‚‡ã†ã€‚å°‘ã—å¤šã™ãã‚‹ã®ã§ã“ã“ã§ã®è¨˜è¼‰ã¯çœç•¥ã—ã¾ã™ãŒã€å„ãƒ•ã‚£ãƒ¼ãƒ‰ã®ãƒ¡ãƒ¢ã‚’ãŠã¾ã‘ã¨ã—ã¦è¿½åŠ ã—ã¦ãŠãã¾ã™ã€‚
<!-- [ç‰¹å¾´ãƒ‡ãƒ¼ã‚¿ã®ãƒ¡ãƒ¢](#_4) -->

## Godotã§å—ã‘å–ã‚‹

c#ã§ã¯ã€UDPã®ã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦`UDPServer`[^3]ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã€ä»¥ä¸‹ã®ã‚ˆã†ã«OpenSeeFaceã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```c#
extends Node

var server := UDPServer.new()

func _ready():
	server.listen(11573)


func _process(delta):
	server.poll()
	if server.is_connection_available():
		var peer = server.take_connection()
		var packet = peer.get_packet()
```

å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿(`packet`)ã¯byteå½¢å¼ã§ã™ã®ã§ã€ã“ã¡ã‚‰ã‚’å¤‰æ›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãã“ã§ä¸€æ—¦ã€å¤‰æ›ç”¨ã®é–¢æ•°ã‚’å®šç¾©ã—ã¦ãŠãã¾ã™ã€‚(ã‚‚ã—ã‹ã™ã‚‹ã¨ã‚‚ã†å°‘ã—ã„ã„å¤‰æ›æ–¹æ³•ãŒã‚ã‚‹ã‹ã‚‚ã§ã™ã€‚)

```c#
func bytes_to_double(bytes):
	var double: float = 0.0
	if bytes.size() == 8:
		var f64 = bytes.decode_double(0)
		double = float(f64)
	return double


func bytes_to_int(bytes):
	var integer: int = 0
	if bytes.size() == 4:
		var i32 = bytes.decode_u32(0)
		integer = int(i32)
	return integer


func bytes_to_float(bytes):
	var float_number: float = 0.0
	if bytes.size() == 4:
		var f32 = bytes.decode_float(0)
		float_number = float(f32)
	return float_number
```

ã‚ã¨ã¯ã„ã„æ„Ÿã˜ã«å—ã‘å–ã£ãŸãƒ‡ãƒ¼ã‚¿ã‚’åŒºåˆ‡ã£ã¦ã€è¾æ›¸å‹ã«ä¿å­˜ã™ã‚‹é–¢æ•°ã‚’å®šç¾©ã—ã¾ã™ã€‚

ã“ã‚Œã§`data`ã‚’å–å¾—ã™ã‚‹ã“ã¨ã§ç‰¹å¾´ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚

```c#

func parse_packet(packet):
	var data = {}
	var index = 0

	var timestamp_bytes = packet.slice(index, index + 8)
	var timestamp = bytes_to_double(timestamp_bytes)
	data["timestamp"] = timestamp
	index += 8

	var face_id_bytes = packet.slice(index, index + 4)
	var face_id = bytes_to_int(face_id_bytes)
	data["face_id"] = face_id
	index += 4

	var width_bytes = packet.slice(index, index + 4)
	var width = bytes_to_float(width_bytes)
	data["width"] = width
	index += 4

	var height_bytes = packet.slice(index, index + 4)
	var height = bytes_to_float(height_bytes)
	data["height"] = height
	index += 4

	data["eye_blink"] = []
	data["eye_blink"].append(bytes_to_float(packet.slice(index, index + 4)))
	index += 4
	data["eye_blink"].append(bytes_to_float(packet.slice(index, index + 4)))
	index += 4

	var success_bytes = packet.slice(index, index + 1)
	var success = bytes_to_int(success_bytes)
	data["success"] = success
	index += 1

	var pnp_error_bytes = packet.slice(index, index + 4)
	var pnp_error = bytes_to_float(pnp_error_bytes)
	data["pnp_error"] = pnp_error
	index += 4

	var quaternions = []
	for i in range(4):
		quaternions.append(bytes_to_float(packet.slice(index + i * 4, index + (i + 1) * 4)))
		data["quaternion"] = quaternions

	var eulers = []
	for i in range(3):
		eulers.append(bytes_to_float(packet.slice(index + i * 4, index + (i + 1) * 4)))
	data["euler"] = eulers
	index += 12

	var translations = []
	for i in range(3):
		translations.append(bytes_to_float(packet.slice(index + i * 4, index + (i + 1) * 4)))
	data["translation"] = translations
	index += 12

	index += 66 * 3 * 4  # Landmark

	index += 66 * 3 * 4  # Point3D

	index += 18 * 4  # ???

	# Feature list
	var features = [
		"eye_l", "eye_r", "eyebrow_steepness_l", "eyebrow_quirk_l",
		"eyebrow_steepness_r", "eyebrow_quirk_r", "eyebrow_updown_l",
		"eyebrow_updown_r", "mouth_corner_updown_l", "mouth_corner_inout_l",
		"mouth_corner_updown_r", "mouth_corner_inout_r", "mouth_open", "mouth_wide"
	]

	data["features"] = {}
	for i in range(14):
		data["features"][features[i]] = bytes_to_float(packet.slice(index, index + 4))
		index += 4

	return data
```




## pythonã‚’Godotã‹ã‚‰å‘¼ã¶

ã„ã¡ã„ã¡ã€`facetracker.py`ã‚’èµ·å‹•ã—ã¦ã€Godotã§ãƒ‘ãƒšãƒƒãƒˆã‚’èµ·å‹•ã—ã¦ã¨ã™ã‚‹ã®ã¯éå¸¸ã«æ‰‹é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚

ãã“ã§mainã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãªã©ã§æœ€åˆã«å®Ÿè¡Œã—ã¦ã—ã¾ã†ã“ã¨ã«ã—ã¾ã™ã€‚

`OS.execute`[^4]ã‚’ä½¿ã†ã¨ã€OpenSeeFaceãŒåœæ­¢ã™ã‚‹ã¾ã§ã€ãã‚Œä»¥é™ã®å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã€‚

ãã®ãŸã‚ã€`OS.create_process`[^5]ã‚’ä½¿ç”¨ã—ã¦ã€æ–°ã—ã„ãƒ—ãƒ­ã‚»ã‚¹ã‚’ä½œæˆã—ã€å®Ÿè¡Œã—ã¾ã™ã€‚

```c#
const python_cmd = "<path to python>"

func run_py():
	var output = []
	var args = [
		"OpenSeeFace/facetracker.py", 
		"--visualize", "3", 
		"--pnp-points", "1", 
		"--max-threads", "4", 
		"-c", "0", 
		"-P", "1", 
		"-F", "60"]
	var pid = OS.create_process(python_cmd, args)
	
	return pid
```

ã“ã‚Œã§å®Ÿè¡Œã¯ã•ã‚Œã¾ã™ã€‚ã—ã‹ã—ã€ã“ã‚Œã ã¨GodotãŒçµ‚äº†ã—ã¦ã‚‚ãƒ—ãƒ­ã‚»ã‚¹ãŒå®Ÿè¡Œã•ã‚Œç¶šã‘ã¦ã—ã¾ã„ã¾ã™ã€‚

`_notification`é–¢æ•°å†…ã§`NOTIFICATION_WM_CLOSE_REQUEST`ã‚’ä½¿ç”¨ã—ã¦ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‰ã˜ã‚‰ã‚ŒãŸã“ã¨ã‚’æ¤œå‡ºã—ã¾ã™ã€‚ã€‚

ã‚ã¨ã¯ã€å®Ÿè¡Œæ™‚ã«å–å¾—ã—ãŸpidã‚’ä½¿ã£ã¦`OS.kill`ã«ã‚ˆã£ã¦killã—ã¾ã™ã€‚

```c#
func _notification(what):
	if what == NOTIFICATION_WM_CLOSE_REQUEST:
		get_tree().set_auto_accept_quit(false)
		OS.kill(pid)
		get_tree().quit()
```

## ãŠã¾ã‘: ãƒ‘ãƒšãƒƒãƒˆé¢¨ã®å‡ºåŠ›ä¾‹

ä¸Šè¨˜ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ã£ã¦ã€ãŸã‚ã—ã«ãƒ‘ãƒšãƒƒãƒˆã‚’ä½œã£ã¦ã¿ã¾ã—ãŸã€‚

å–å¾—ã—ãŸç‰¹å¾´ãƒ‡ãƒ¼ã‚¿ã®ã†ã¡ç›®ã®é–‹é–‰ã¨å£ã®é–‹é–‰ã€åŠ ãˆã¦é¡”ã®å‚¾ãã‚’ä½¿ç”¨ã—ã¦å‡ºåŠ›ã—ã¦ã„ã¾ã™ã€‚

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">é¡”ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°60fpsã§å‹•ä½œç¢ºèªã—ãŸğŸ‘€ğŸ‘„<a href="https://twitter.com/hashtag/GODOT4?src=hash&amp;ref_src=twsrc%5Etfw">#GODOT4</a> <a href="https://twitter.com/hashtag/OpenSeeFace?src=hash&amp;ref_src=twsrc%5Etfw">#OpenSeeFace</a> <a href="https://t.co/C7iFZoYZJH">pic.twitter.com/C7iFZoYZJH</a></p>&mdash; kosh (@llbxg) <a href="https://twitter.com/llbxg/status/1655534078911991808?ref_src=twsrc%5Etfw">May 8, 2023</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

## ãŠã¾ã‘: ç‰¹å¾´ãƒ‡ãƒ¼ã‚¿ã®ãƒ¡ãƒ¢

å„ãƒ•ã‚£ãƒ¼ãƒ‰ã®ãƒ¡ãƒ¢ã§ã™ã€‚

* Frame, Time: æ˜ åƒãƒ•ãƒ¬ãƒ¼ãƒ ã®IDã¨ãã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã€‚
* Width, Height: æ˜ åƒã®å¹…ã¨é«˜ã•ã€‚
* FPS: æ˜ åƒã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ»ãƒ‘ãƒ¼ãƒ»ã‚»ã‚«ãƒ³ãƒ‰ï¼‰ã€‚
* Face, FaceID: é¡”ã®æ¤œå‡ºã¨ãã®è­˜åˆ¥å­ã€‚
* RightOpen, LeftOpen: å³ç›®ã¨å·¦ç›®ãŒé–‹ã„ã¦ã„ã‚‹ã‹ã©ã†ã‹ã®æŒ‡æ¨™ã€‚
* AverageConfidence: æ¤œå‡ºã•ã‚ŒãŸé¡”ã®ä¿¡é ¼åº¦ã®å¹³å‡ã€‚
* Success3D, PnPError: 3Dé¡”å†æ§‹æˆã®æˆåŠŸã¨ãã®ã‚¨ãƒ©ãƒ¼ã€‚
* RotationQuat.X, Y, Z, W: é¡”ã®å›è»¢ã‚’è¡¨ã™ã‚¯ã‚©ãƒ¼ã‚¿ãƒ‹ã‚ªãƒ³ã€‚
* Euler.X, Y, Z: ã‚ªã‚¤ãƒ©ãƒ¼è§’ã«ã‚ˆã‚‹é¡”ã®å›è»¢ã€‚
* RVec.X, Y, Z, TVec.X, Y, Z: é¡”ã®ä½ç½®ã¨å§¿å‹¢ã‚’è¡¨ã™ãƒ­ãƒ‰ãƒªã‚²ã‚¹ãƒ™ã‚¯ãƒˆãƒ«ã¨å¹³è¡Œç§»å‹•ãƒ™ã‚¯ãƒˆãƒ«ã€‚
* Landmark[i].X, Y, Confidence: iç•ªç›®ã®é¡”ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ï¼ˆç‰¹å¾´ç‚¹ï¼‰ã®ä½ç½®ã¨ãã®ä¿¡é ¼åº¦ã€‚
* Point3D[i].X, Y, Z: iç•ªç›®ã®3Dãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã®ä½ç½®ã€‚
* eye_l, eye_r: å·¦ç›®ã¨å³ç›®ã®é–‹ãå…·åˆã€‚
* eyebrow_steepness_l, eyebrow_updown_l, eyebrow_quirk_l, eyebrow_steepness_r, eyebrow_updown_r, eyebrow_quirk_r: å·¦å³ã®çœ‰ã®ç‰¹æ€§ï¼ˆå‚¾ãã€ä¸Šä¸‹å‹•ã€ç‰¹ç•°ãªå‹•ãï¼‰ã€‚
* mouth_corner_updown_l, mouth_corner_inout_l, mouth_corner_updown_r, mouth_corner_inout_r: å£è§’ã®ä¸Šä¸‹å‹•ã¨å†…å¤–å‹•ã€‚
* mouth_open, mouth_wide: å£ã®é–‹ãå…·åˆã¨å¹…ã€‚

## å‚è€ƒæ–‡çŒ®

[^1]: [emilianavt/OpenSeeFace - GitHub](https://github.com/emilianavt/OpenSeeFace)

[^2]: [OpenSeeFace - GitHub - facetracker.py](https://github.com/emilianavt/OpenSeeFace/blob/master/facetracker.py)

[^3]: [class_udpserver #udpserver - docs.godotengine.org](https://docs.godotengine.org/en/stable/classes/class_udpserver.html#udpserver)

[^4]: [class_os.html #class-os-method-execute - docs.godotengine.org](https://docs.godotengine.org/en/stable/classes/class_os.html#class-os-method-execute)

[^5]: [class_os.html #class-os-method-create-process - docs.godotengine.org](https://docs.godotengine.org/en/stable/classes/class_os.html#class-os-method-create-process)

[^6]: [class_os.html #class-os-method-kill - docs.godotengine.org](https://docs.godotengine.org/en/stable/classes/class_os.html#class-os-method-kill)